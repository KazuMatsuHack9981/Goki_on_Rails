$(document).on("turbolinks:load", function() {
	var space   = document.getElementById("spacebar");
	var environ = document.getElementById("environ");
	var goki = document.getElementById("goki");
	var x=0;
	var y=0;
	var speed=20;




	//movement
	window.addEventListener("keydown", handleKeydown);
	var uparrow    = 38;
	var downarrow  = 40;
	var leftarrow  = 37;
	var rightarrow = 39;
	var spacekey   = 32;


	//idle
	anime({
		targets: goki,
		rotate: 3,
		direction: "alternate",
		loop: true
	});


	//key movement
	function handleKeydown(event) {
		var key=event.keyCode;
		var pos = $("#goki").offset();

		if(key==uparrow && pos.top>160){
			y-=speed;
			$("#goki").css("marginTop", y+"px");
		}
		if(key==downarrow && pos.top<650){
			y+=speed;
			$("#goki").css("marginTop", y+"px");
		}
		if(key==leftarrow && pos.left>-10){
			x-=speed;
			$("#goki").css("marginLeft", x+"px");
		}
		if(key==rightarrow && pos.left<1236){
			x+=speed;
			$("#goki").css("marginLeft", x+"px");
		}


		//space
		if(key==spacekey) {
			anime({
				targets: goki,
				translateX: 200,
				duration: 50,
				direction: "alternate"
			});
		}
	}




	//enemy move
	anime({
		targets: ".jet",
		translateY: 10,
		direction: "alternate",
		loop: true
	});



	//arrows
	var field = document.getElementsByClassName("heroes")[0];
	var maxtop = 750;
	var mintop = 220;
	var maxspeed = 30;
	var minspeed = 10;
	var arrow_speed = 50;
	var score = 0;


	//arrow generation
	function generate_arrow() {
		var arrow = document.createElement("img");
		arrow.src = "<%= asset_path "maingokis/index/enemy/arrow.png" %>";
		arrow.style.width = "120px";
		arrow.style.height = "30px";
		arrow.style.float = "right";
		arrow.style.left = "1400px";
		arrow.style.top = String(Math.floor(
			Math.random()*(maxtop-mintop) + mintop
		)) + "px";
		arrow.style.position = "absolute";
		arrow.classList.add("arrow");
		field.appendChild(arrow);
	}

	setInterval(
		function(){
			generate_arrow();
		}
	, 2000);


	//arrow move & destroy & collision
	setInterval(
		function(){
			$(".arrow").each(function(i,elem){
				//collision
				var xdist = $("#goki").position().left - $(elem).position().left;
				var ydist = $("#goki").position().top - $(elem).position().top;
				var dist  = Math.pow(xdist,2) + Math.pow(ydist,2);
				if(dist<60000) {
					$("#goki").remove();
					window.location.replace("/gokicollections");
				}

				//destroy
				if($(elem).position().left < 0){
					$(elem).remove();
					score += 1;
					document.getElementById("score").innerHTML = String(score);
				}
			});

			//arrow move
			$(".arrow").offset(function(i,elem){
				return {
					top:  elem.top,
					left: elem.left - arrow_speed
				};
			});
		}
	, 50);

	

	


	//environment
	var grass = "grass";
	var sand = "sand";
	var crack = "crack";

	$("#environ").click(
		function() {
			var current = $(".main").css("background-image").toString();
			if(current.includes(grass)==true){
				$(".main").css("background-image", "url(<%= asset_path "maingokis/index/mainbg/sand.png" %>)");
			}
			else if(current.includes(sand)==true){
				$(".main").css("background-image", "url(<%= asset_path "maingokis/index/mainbg/crack.png" %>)");
			}
			else if(current.includes(crack)==true){
				$(".main").css("background-image", "url(<%= asset_path "maingokis/index/mainbg/grass.png" %>)");
			}
		}
	)


	//dokuro
	$("#spacebar").click(
		function(){
			anime({
				targets: goki,
				rotate: 360,
				translateX: 20,
				duration: 1500
			});
		}
	)

	

	//hover
	$(".footbutton").hover(
		function(){
			anime({
				targets: this,
				rotate: 3,
				direction: "alternate",
				duration: 20
			});
		}
	)
});

